<!DOCTYPE html>
<!--
  analyze.html
  Version: v2025.12.12-2 (AIVI rebrand + improved loading behavior + fetch timeout)
  Last updated: 2025-12-12
  Timestamp: 2025-12-12T00:30 America/New_York

  CHANGES IN THIS VERSION:
  - Rebranded UI copy to: AIVI / AI Visibility Index (replacing AiVi)
  - Improved loading UX so it wonâ€™t â€œfeel stuckâ€ at 95%:
      - Adds a lightweight progress modal + status lines
      - Progress caps at 95% until API returns, then completes to 100%
      - Shows elapsed time + â€œstill workingâ€ messaging after 30s
      - Adds Cancel + Retry actions
  - Adds fetch timeout via AbortController (default 120s) with graceful fallback
  - Keeps /api/full as the data source (no endpoint changes)

  HOW IT WORKS:
  - Page reads ?url=https://example.com
  - Calls: /api/full?url=<encoded target url>
  - Uses response fields: success, rawScore/score, breakdown, technical, answerability,
    whatsWorking, needsAttention, engineInsights, opportunities
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AIVI â€” AI Visibility Index</title>
  <style>
    :root{
      --max-width:760px; --pad-v:3vh; --pad-h:2rem;
      --muted:#666; --border:#e5e5e5;
      --primary:#3182CE; --primary-hover:#2563EB;
    }
    *{box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;
      background:#fff;color:#000;margin:0;
      padding:var(--pad-v) var(--pad-h);
      max-width:var(--max-width);
      margin-inline:auto;
      display:flex;flex-direction:column;align-items:flex-start
    }
    h1{
      font-size:4rem;font-weight:700;margin:0 0 .25em;line-height:1;letter-spacing:-1px;
      background:linear-gradient(135deg,#000 0%,var(--primary) 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
    }
    h2{font-size:1.6rem;font-weight:700;margin:0 0 1rem}
    p{font-size:1.075rem;line-height:1.65;margin:0 0 1rem}

    .info-row{width:100%;display:flex;gap:1rem;align-items:center;justify-content:space-between;margin:.25rem 0 1rem}
    .powered-by,.for-url{color:var(--muted);font-size:.95rem}
    .powered-by a{color:var(--primary);text-decoration:none;font-weight:600}
    .for-url strong{color:#000}

    .card{width:100%;border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff}
    .score-card{padding:1rem;margin-bottom:2.25rem}
    .score-top{display:flex;align-items:center;gap:.75rem;justify-content:space-between;flex-wrap:wrap}
    .score-main{display:flex;align-items:baseline;gap:.5rem}
    .score-number{font-size:2.25rem;font-weight:800}
    .score-band{color:var(--muted);font-size:.95rem}

    .btn-row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .btn-ghost{
      border:1px solid #111;background:#fff;color:#111;
      padding:.55rem .9rem;border-radius:8px;cursor:pointer;
      font-weight:700;font-size:.95rem;transition:.2s;white-space:nowrap
    }
    .btn-ghost:hover{background:#f2f2f2}
    .btn-ghost.primary{
      border-color:var(--primary);
      color:#fff;background:var(--primary);
    }
    .btn-ghost.primary:hover{background:var(--primary-hover);border-color:var(--primary-hover)}

    .pillars{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:.75rem}
    .pillar{border:1px solid var(--border);border-radius:10px;padding:.6rem .75rem;display:flex;align-items:center;justify-content:space-between;font-size:.98rem;background:#fff}
    .pillar .label{font-weight:600}
    .badge{font-weight:700;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:.85rem;background:#fafafa}

    #summary-results .section-title{font-size:1.25rem!important;font-weight:700!important;margin:2rem 0 .6rem!important}
    #summary-results p{line-height:1.68!important;margin:0 0 .9rem!important;font-size:1.05rem!important;white-space:pre-line}
    #summary-results ul{margin:0 0 1.1rem 1.1rem!important;padding-left:.2rem!important;list-style:disc!important}
    #summary-results li{line-height:1.7!important;margin:.6rem 0!important;font-size:1.05rem!important}

    .key-card{padding:1rem;margin-top:.75rem}
    .key-card h3{margin:.25rem 0 .75rem;font-size:1.1rem}
    .key-card ul{margin:.25rem 0 0 1.1rem;padding-left:.2rem}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{background:#fff;border-radius:12px;padding:1.5rem;width:min(580px,90vw);max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;border-bottom:1px solid #e5e5e5;padding-bottom:.75rem}
    .modal-title{font-size:1.25rem;font-weight:700;margin:0}
    .modal-close{background:transparent;border:0;font-size:1.5rem;cursor:pointer;padding:.25rem;color:#666;line-height:1}
    .modal-close:hover{color:#000}
    .modal-content p{font-size:.95rem;line-height:1.55;color:#333;margin:.75rem 0}
    .modal-content p strong{color:#111}

    /* Loading modal */
    .load-title{font-size:1.05rem;font-weight:800;margin:0 0 .65rem}
    .load-row{display:flex;align-items:center;justify-content:space-between;gap:1rem}
    .load-pct{font-weight:800;color:#111}
    .progress-wrap{width:100%;height:10px;border-radius:999px;background:#edf2f7;overflow:hidden;border:1px solid #e2e8f0}
    .progress-bar{height:100%;width:0%;background:var(--primary);transition:width .35s ease}
    .load-lines{margin:.75rem 0 0;color:#444;font-size:.95rem;line-height:1.45}
    .load-lines .muted{color:var(--muted)}
    .load-actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;flex-wrap:wrap}

    .footer{width:100%;text-align:center;padding:2rem 0 1rem;margin-top:3rem;color:#666;font-size:.85rem}
    .footer a{color:var(--primary);text-decoration:none}
  </style>
</head>
<body>
  <h1>AIVI</h1>
  <h2>AI Visibility Index</h2>

  <div class="info-row">
    <div class="powered-by">Powered by <a href="https://quontora.com" target="_blank" rel="noreferrer">Quontora</a></div>
    <div class="for-url">Analysis for: <strong id="current-url">-</strong></div>
  </div>

  <section class="card score-card" id="scoreCard" aria-live="polite">
    <div class="score-top">
      <div class="score-main">
        <div class="score-number" id="scoreNumber">-</div>
        <div class="score-band" id="scoreBand">Loading AIVI score...</div>
      </div>
      <div class="btn-row">
        <button class="btn-ghost" id="breakdownBtn" type="button">What goes into this score?</button>
        <button class="btn-ghost" id="copyBtn" type="button">Copy Summary</button>
        <button class="btn-ghost primary" id="fullBtn" type="button">View Full Report</button>
        <button class="btn-ghost" onclick="window.print()" type="button">ðŸ“„ Print</button>
        <button class="btn-ghost" id="emailBtn" type="button">ðŸ“§ Email</button>
      </div>
    </div>
    <div class="pillars" id="pillarsGrid"></div>

    <div class="card key-card" id="keyFindingsCard" style="display:none;">
      <h3>Key Findings</h3>
      <ul id="keyFindingsList"></ul>
    </div>
  </section>

  <section id="summary-results">
    <p style="text-align:center;color:gray;">Loading AI Visibility analysis...</p>
  </section>

  <div class="footer">
    Â© 2025 AIVI by <a href="https://quontora.com" target="_blank" rel="noreferrer">Quontora</a>. Last updated <span id="footer-date"></span>.
  </div>

  <!-- Score breakdown modal -->
  <div id="breakdown-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h3 class="modal-title">What goes into this score?</h3>
        <button class="modal-close" id="modal-close" aria-label="Close">Ã—</button>
      </div>
      <div class="modal-content">
        <p><strong>AI Access Readiness</strong><br>How easily AI systems can discover and access your content.</p>
        <p><strong>Trust & Verification Signals</strong><br>Authority signals AI uses to assess credibility.</p>
        <p><strong>LLM Interpretability & Clarity</strong><br>How clearly your content can be parsed and summarized.</p>
        <p><strong>Technical & Retrieval Alignment</strong><br>Technical factors that influence crawl, extraction, and answerability.</p>
      </div>
    </div>
  </div>

  <!-- Loading modal -->
  <div id="loading-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h3 class="modal-title" style="margin:0">Analyzing your websiteâ€¦</h3>
        <button class="modal-close" id="loading-close" aria-label="Close">Ã—</button>
      </div>

      <div class="load-row">
        <div class="load-title" id="loadStatus">Startingâ€¦</div>
        <div class="load-pct" id="loadPct">0%</div>
      </div>
      <div class="progress-wrap" aria-label="Loading progress">
        <div class="progress-bar" id="loadBar"></div>
      </div>

      <div class="load-lines" id="loadLines">
        <div>Fetching site signalsâ€¦</div>
        <div class="muted" id="loadElapsed">Elapsed: 0s</div>
      </div>

      <div class="load-actions">
        <button class="btn-ghost" id="retryBtn" type="button" style="display:none;">Retry</button>
        <button class="btn-ghost" id="cancelBtn" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Footer date
    (function(){
      const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
      const d=new Date();
      document.getElementById("footer-date").textContent = `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
    })();

    const urlParams = new URLSearchParams(window.location.search);
    const targetUrl = urlParams.get("url");

    // Modal handlers (score breakdown)
    document.getElementById('breakdownBtn')?.addEventListener('click', () => {
      const bd = document.getElementById('breakdown-modal');
      bd.style.display = 'flex';
      bd.setAttribute('aria-hidden', 'false');
    });

    function closeBreakdown(){
      const bd = document.getElementById('breakdown-modal');
      bd.style.display = 'none';
      bd.setAttribute('aria-hidden', 'true');
    }

    document.getElementById('modal-close')?.addEventListener('click', closeBreakdown);
    document.getElementById('breakdown-modal')?.addEventListener('click', (e) => {
      if (e.target === document.getElementById('breakdown-modal')) closeBreakdown();
    });

    // Loading modal helpers
    const loadingModal = document.getElementById('loading-modal');
    const loadPctEl = document.getElementById('loadPct');
    const loadBarEl = document.getElementById('loadBar');
    const loadStatusEl = document.getElementById('loadStatus');
    const loadElapsedEl = document.getElementById('loadElapsed');
    const retryBtn = document.getElementById('retryBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const loadingCloseBtn = document.getElementById('loading-close');

    let progressTimer = null;
    let elapsedTimer = null;
    let progressValue = 0;
    let startedAt = 0;
    let currentAbort = null;
    let lastFetchUrl = null;

    function showLoading(){
      loadingModal.style.display = 'flex';
      loadingModal.setAttribute('aria-hidden','false');
    }
    function hideLoading(){
      loadingModal.style.display = 'none';
      loadingModal.setAttribute('aria-hidden','true');
    }
    function setProgress(pct){
      const clamped = Math.max(0, Math.min(100, Math.round(pct)));
      progressValue = clamped;
      loadPctEl.textContent = `${clamped}%`;
      loadBarEl.style.width = `${clamped}%`;
    }
    function setStatus(txt){
      loadStatusEl.textContent = txt;
    }
    function setLines(lines){
      const host = document.getElementById('loadLines');
      host.innerHTML = lines.map((l,i)=> i===lines.length-1 ? `<div class="muted">${l}</div>` : `<div>${l}</div>`).join('');
    }
    function startProgress(){
      stopProgress();

      retryBtn.style.display = 'none';
      setProgress(0);
      setStatus("Startingâ€¦");
      startedAt = Date.now();

      showLoading();

      // Progress logic: ramps up to 90, then to 95, then waits.
      progressTimer = setInterval(() => {
        // If already waiting at 95, do nothing.
        if (progressValue >= 95) return;

        // Smooth-ish increments
        if (progressValue < 65) progressValue += 4;
        else if (progressValue < 85) progressValue += 2;
        else progressValue += 1;

        // Cap at 95 while waiting
        if (progressValue > 95) progressValue = 95;

        setProgress(progressValue);

        // Status messaging by phase
        if (progressValue < 25) {
          setStatus("Fetching site signalsâ€¦");
        } else if (progressValue < 55) {
          setStatus("Parsing structure and metadataâ€¦");
        } else if (progressValue < 80) {
          setStatus("Evaluating AI interpretabilityâ€¦");
        } else {
          setStatus("Finalizing AIVI scoringâ€¦");
        }
      }, 550);

      elapsedTimer = setInterval(() => {
        const secs = Math.floor((Date.now() - startedAt) / 1000);
        const elapsedText = `Elapsed: ${secs}s`;
        const host = document.getElementById('loadLines');

        // Keep the last line as elapsed
        const base = [
          "Fetching site signalsâ€¦",
          "Processing content structure and AI visibility signalsâ€¦",
          secs >= 30 ? "Still working â€” some sites take longer (heavy pages, bot rules, network latency)." : "Almost done!",
          elapsedText
        ];
        setLines(base);

        // If itâ€™s taking a while, ensure weâ€™re not â€œstuck-lookingâ€
        if (secs >= 25 && progressValue < 95) setProgress(95);
      }, 1000);
    }
    function stopProgress(){
      if (progressTimer) clearInterval(progressTimer);
      if (elapsedTimer) clearInterval(elapsedTimer);
      progressTimer = null;
      elapsedTimer = null;
    }
    function finishProgress(){
      stopProgress();
      setStatus("Complete");
      setProgress(100);
      // brief pause so user sees completion
      setTimeout(() => hideLoading(), 350);
    }
    function failProgress(message){
      stopProgress();
      setStatus("Couldnâ€™t complete analysis");
      setProgress(95);
      const secs = Math.floor((Date.now() - startedAt) / 1000);
      setLines([
        "We couldnâ€™t finish this run.",
        message || "Please retry. If this persists, the site may be blocking crawlers or timing out.",
        `Elapsed: ${secs}s`
      ]);
      retryBtn.style.display = 'inline-block';
    }

    loadingCloseBtn?.addEventListener('click', () => {
      // Close just hides UI; does not cancel unless user hits Cancel
      hideLoading();
    });

    cancelBtn?.addEventListener('click', () => {
      if (currentAbort) currentAbort.abort();
      hideLoading();
    });

    retryBtn?.addEventListener('click', () => {
      if (lastFetchUrl) runAnalysis(lastFetchUrl);
    });

    // Email
    document.getElementById('emailBtn')?.addEventListener('click', () => {
      const subject = encodeURIComponent(`AIVI Report for ${targetUrl || ''}`);
      const body = encodeURIComponent(`View analysis: ${window.location.href}`);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    // Copy summary
    document.getElementById("copyBtn")?.addEventListener("click", async () => {
      const scoreText = document.getElementById("scoreNumber").textContent || "-/100";
      const txt = `Website: ${targetUrl}\nAIVI Score: ${scoreText}\n\nAnalysis: ${window.location.href}`;
      try {
        await navigator.clipboard.writeText(txt);
        const b = document.getElementById("copyBtn");
        const old = b.textContent;
        b.textContent = "âœ“ Copied!";
        setTimeout(() => b.textContent = old, 1500);
      } catch {
        window.prompt("Copy the summary:", txt);
      }
    });

    // Full report button
    document.getElementById("fullBtn")?.addEventListener("click", () => {
      if (!targetUrl) return;
      window.location.href = `/full-report.html?url=${encodeURIComponent(targetUrl)}`;
    });

    function safeArr(x){ return Array.isArray(x) ? x : []; }

    function toPillarPoints(val){
      const n = Number(val);
      if (!isFinite(n)) return 0;
      // If backend sends >25 (e.g., presence ~49), normalize to /25
      const normalized = n > 25 ? (n / 2) : n;
      return Math.max(0, Math.min(25, Math.round(normalized)));
    }

    function renderScoreCard(fullData){
      const raw = Number(fullData.rawScore ?? fullData.score?.rawScore ?? fullData.score ?? 0) || 0;
      const breakdown = fullData.breakdown || fullData.score?.breakdown || {};

      document.getElementById("scoreNumber").textContent = `${Math.round(raw)}/100`;
      document.getElementById("scoreBand").textContent =
        raw >= 80 ? "Rank: Excellent â˜…â˜…â˜…â˜…â˜…" :
        raw >= 60 ? "Rank: Strong â˜…â˜…â˜…â˜…â˜†" :
        raw >= 40 ? "Rank: Developing â˜…â˜…â˜…â˜†â˜†" :
        "Rank: At Risk â˜…â˜…â˜†â˜†â˜†";

      const grid = document.getElementById("pillarsGrid");
      grid.innerHTML = "";

      const pillars = [
        ["AI Access Readiness", toPillarPoints(breakdown.presence)],
        ["Trust & Verification Signals", toPillarPoints(breakdown.citations)],
        ["LLM Interpretability & Clarity", toPillarPoints(breakdown.answerability)],
        ["Technical & Retrieval Alignment", toPillarPoints(breakdown.technical)]
      ];

      pillars.forEach(([label, val]) => {
        const d = document.createElement("div");
        d.className = "pillar";
        d.innerHTML = `<span class="label">${label}</span><span class="badge">${val}/25</span>`;
        grid.appendChild(d);
      });
    }

    function buildKeyFindings(fullData){
      const tech = fullData.technical || {};
      const ans = fullData.answerability || {};

      const items = [];

      if (tech.indexable === true) items.push("Site appears indexable â€” supports discoverability.");
      if (tech.hasCanonical === true) items.push("Canonical tag detected â€” helps AI understand preferred URLs.");
      if (tech.hasTitleAndH1 === false) items.push("Missing or weak <title>/<h1> detected â€” major clarity signal for AI.");
      if (tech.performanceOk === false) items.push("Performance flags detected â€” can reduce crawl/parse success.");

      if (ans.hasFAQSchema === false) items.push("No FAQ schema detected â€” reduces Q&A answerability signals.");
      if (ans.entitiesInHeadings === true) items.push("Entities appear in headings â€” helps AI map topics.");
      if (ans.hasOtherSchema === true) items.push("Some structured data detected â€” helps AI interpret meaning.");

      return items;
    }

    function renderSections(fullData){
      const host = document.getElementById('summary-results');
      let html = '';

      const whatsWorking = safeArr(fullData.whatsWorking);
      const needsAttention = safeArr(fullData.needsAttention);
      const engineInsights = safeArr(fullData.engineInsights);
      const opportunities = safeArr(fullData.opportunities);

      if (whatsWorking.length) {
        html += '<h3 class="section-title">âœ… What\'s Working</h3><ul>';
        whatsWorking.forEach(item => html += `<li>${item}</li>`);
        html += '</ul>';
      }

      if (needsAttention.length) {
        html += '<h3 class="section-title">ðŸš¨ Needs Attention</h3><ul>';
        needsAttention.forEach(item => html += `<li>${item}</li>`);
        html += '</ul>';
      }

      if (engineInsights.length) {
        html += '<h3 class="section-title">ðŸ“¡ AI Engine Insights</h3><ul>';
        engineInsights.forEach(item => html += `<li>${item}</li>`);
        html += '</ul>';
      }

      if (opportunities.length) {
        html += '<h3 class="section-title">ðŸŽ¯ Top Opportunities</h3><ul>';
        opportunities.slice(0, 10).forEach(opp => {
          const title = opp?.title ? `<strong>${opp.title}</strong>` : "<strong>Opportunity</strong>";
          const desc = opp?.description ? ` â€” ${opp.description}` : "";
          html += `<li>${title}${desc}</li>`;
        });
        html += '</ul>';
      }

      if (!html) {
        html = "<p style='text-align:center;color:#666'>No detailed sections were returned for this run.</p>";
      }

      host.innerHTML = html;
    }

    async function fetchWithTimeout(url, timeoutMs){
      const controller = new AbortController();
      currentAbort = controller;

      const t = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(t);
        return res;
      } catch (err) {
        clearTimeout(t);
        throw err;
      } finally {
        currentAbort = null;
      }
    }

    async function runAnalysis(url){
      lastFetchUrl = url;

      // Reset UI
      document.getElementById("scoreBand").textContent = "Running AIVI analysisâ€¦";
      document.getElementById("scoreNumber").textContent = "â€”";
      document.getElementById("pillarsGrid").innerHTML = "";
      document.getElementById("keyFindingsCard").style.display = "none";
      document.getElementById('summary-results').innerHTML =
        "<p style='text-align:center;color:gray;'>Loading AI Visibility analysis...</p>";

      startProgress();

      try {
        // 120s default timeout for /api/full (deep crawl / LLM steps may be slow)
        const res = await fetchWithTimeout(url, 120000);

        let data = null;
        try {
          data = await res.json();
        } catch {
          data = null;
        }

        if (!res.ok || !data) {
          const msg = `Server returned ${res.status || 'an error'} â€” please retry.`;
          failProgress(msg);
          document.getElementById('summary-results').innerHTML =
            `<p style="text-align:center;color:#666">${msg}</p>`;
          document.getElementById("scoreBand").textContent = "Score unavailable";
          document.getElementById("scoreNumber").textContent = "â€”";
          return;
        }

        if (data.success !== true) {
          const msg = data?.error ? String(data.error) : "Analysis unavailable.";
          failProgress(msg);
          document.getElementById('summary-results').innerHTML =
            `<p style="text-align:center;color:#666">${msg}</p>`;
          document.getElementById("scoreBand").textContent = "Score unavailable";
          document.getElementById("scoreNumber").textContent = "â€”";
          return;
        }

        renderScoreCard(data);

        const kf = buildKeyFindings(data);
        if (kf.length) {
          document.getElementById("keyFindingsCard").style.display = "block";
          const ul = document.getElementById("keyFindingsList");
          ul.innerHTML = "";
          kf.forEach(t => {
            const li = document.createElement("li");
            li.textContent = t;
            ul.appendChild(li);
          });
        }

        renderSections(data);

        finishProgress();

      } catch (e) {
        const isAbort = (e && (e.name === "AbortError"));
        const msg = isAbort
          ? "This run timed out. Some sites take longer (or block crawlers). Please retry."
          : "Detailed AI Visibility findings are not available for this run.";
        console.error("Analyze error:", e);

        failProgress(msg);

        document.getElementById('summary-results').innerHTML =
          `<p style='text-align:center;color:#666'>${msg}</p>`;
        document.getElementById("scoreBand").textContent = "Score unavailable";
        document.getElementById("scoreNumber").textContent = "â€”";
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      if (!targetUrl) {
        document.getElementById("current-url").textContent = "No URL provided";
        document.getElementById('summary-results').innerHTML =
          "<p style='text-align:center;color:red'>No URL provided. Please return to the <a href='/'>homepage</a> and enter a site to analyze.</p>";
        return;
      }

      document.getElementById("current-url").textContent = targetUrl;

      // Run analysis
      const endpoint = `/api/full?url=${encodeURIComponent(targetUrl)}`;
      runAnalysis(endpoint);
    });
  </script>
</body>
</html>
