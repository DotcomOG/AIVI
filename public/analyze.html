<!DOCTYPE html>
<!--
  analyze.html
  Version: v2025.12.12-2 (Fix: API fallback + retry, no design changes)
  Last updated: 2025-12-12
  Timestamp: 2025-12-12T00:00 America/New_York

  CHANGES IN THIS VERSION:
  - Adds backend fallback: if /api/full fails on Vercel, try Render /api/full
  - Adds robust error messaging and a working Retry action
  - No layout/styling changes, no feature additions beyond reliability

  HOW IT WORKS:
  - Page reads ?url=https://example.com
  - Calls: /api/full?url=<encoded target url>
  - If that fails (404/500/network), calls Render: https://sniperank-v2-dev.onrender.com/api/full?url=<encoded>
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AiVi - AI Visibility Analysis</title>
  <style>
    :root{
      --max-width:760px; --pad-v:3vh; --pad-h:2rem;
      --muted:#666; --border:#e5e5e5;
      --primary:#3182CE; --primary-hover:#2563EB;
    }
    *{box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;
      background:#fff;color:#000;margin:0;
      padding:var(--pad-v) var(--pad-h);
      max-width:var(--max-width);
      margin-inline:auto;
      display:flex;flex-direction:column;align-items:flex-start
    }
    h1{
      font-size:4rem;font-weight:700;margin:0 0 .25em;line-height:1;letter-spacing:-1px;
      background:linear-gradient(135deg,#000 0%,var(--primary) 100%);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
    }
    h2{font-size:1.6rem;font-weight:700;margin:0 0 1rem}
    p{font-size:1.075rem;line-height:1.65;margin:0 0 1rem}

    .info-row{width:100%;display:flex;gap:1rem;align-items:center;justify-content:space-between;margin:.25rem 0 1rem}
    .powered-by,.for-url{color:var(--muted);font-size:.95rem}
    .powered-by a{color:var(--primary);text-decoration:none;font-weight:600}
    .for-url strong{color:#000}

    .card{width:100%;border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff}
    .score-card{padding:1rem;margin-bottom:2.25rem}
    .score-top{display:flex;align-items:center;gap:.75rem;justify-content:space-between;flex-wrap:wrap}
    .score-main{display:flex;align-items:baseline;gap:.5rem}
    .score-number{font-size:2.25rem;font-weight:800}
    .score-band{color:var(--muted);font-size:.95rem}

    .btn-row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .btn-ghost{
      border:1px solid #111;background:#fff;color:#111;
      padding:.55rem .9rem;border-radius:8px;cursor:pointer;
      font-weight:700;font-size:.95rem;transition:.2s;white-space:nowrap
    }
    .btn-ghost:hover{background:#f2f2f2}

    .pillars{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:.75rem}
    .pillar{border:1px solid var(--border);border-radius:10px;padding:.6rem .75rem;display:flex;align-items:center;justify-content:space-between;font-size:.98rem;background:#fff}
    .pillar .label{font-weight:600}
    .badge{font-weight:700;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:.85rem;background:#fafafa}

    #summary-results .section-title{font-size:1.25rem!important;font-weight:700!important;margin:2rem 0 .6rem!important}
    #summary-results p{line-height:1.68!important;margin:0 0 .9rem!important;font-size:1.05rem!important;white-space:pre-line}
    #summary-results ul{margin:0 0 1.1rem 1.1rem!important;padding-left:.2rem!important;list-style:disc!important}
    #summary-results li{line-height:1.7!important;margin:.6rem 0!important;font-size:1.05rem!important}

    .key-card{padding:1rem;margin-top:.75rem}
    .key-card h3{margin:.25rem 0 .75rem;font-size:1.1rem}
    .key-card ul{margin:.25rem 0 0 1.1rem;padding-left:.2rem}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{background:#fff;border-radius:12px;padding:1.5rem;width:min(580px,90vw);max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;border-bottom:1px solid #e5e5e5;padding-bottom:.75rem}
    .modal-title{font-size:1.25rem;font-weight:700;margin:0}
    .modal-close{background:transparent;border:0;font-size:1.5rem;cursor:pointer;padding:.25rem;color:#666;line-height:1}
    .modal-close:hover{color:#000}
    .modal-content p{font-size:.95rem;line-height:1.55;color:#333;margin:.75rem 0}
    .modal-content p strong{color:#111}

    .footer{width:100%;text-align:center;padding:2rem 0 1rem;margin-top:3rem;color:#666;font-size:.85rem}
    .footer a{color:var(--primary);text-decoration:none}
  </style>
</head>
<body>
  <h1>AiVi</h1>
  <h2>AI Visibility Analysis</h2>

  <div class="info-row">
    <div class="powered-by">Powered by <a href="https://quontora.com" target="_blank" rel="noreferrer">Quontora</a></div>
    <div class="for-url">Analysis for: <strong id="current-url">-</strong></div>
  </div>

  <section class="card score-card" id="scoreCard" aria-live="polite">
    <div class="score-top">
      <div class="score-main">
        <div class="score-number" id="scoreNumber">-</div>
        <div class="score-band" id="scoreBand">Loading AIV Score...</div>
      </div>
      <div class="btn-row">
        <button class="btn-ghost" id="breakdownBtn" type="button">What goes into this score?</button>
        <button class="btn-ghost" id="copyBtn" type="button">Copy Summary</button>
        <button class="btn-ghost" id="fullBtn" type="button">View Full Report</button>
        <button class="btn-ghost" onclick="window.print()" type="button">ðŸ“„ Print</button>
        <button class="btn-ghost" id="emailBtn" type="button">ðŸ“§ Email</button>
        <button class="btn-ghost" id="retryBtn" type="button" style="display:none">â†» Retry</button>
      </div>
    </div>
    <div class="pillars" id="pillarsGrid"></div>

    <div class="card key-card" id="keyFindingsCard" style="display:none;">
      <h3>Key Findings</h3>
      <ul id="keyFindingsList"></ul>
    </div>
  </section>

  <section id="summary-results">
    <p style="text-align:center;color:gray;">Loading AI Visibility analysis...</p>
  </section>

  <div class="footer">
    Â© 2025 AiVi by <a href="https://quontora.com" target="_blank" rel="noreferrer">Quontora</a>. Last updated December 12, 2025.
  </div>

  <div id="breakdown-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h3 class="modal-title">What goes into this score?</h3>
        <button class="modal-close" id="modal-close" aria-label="Close">Ã—</button>
      </div>
      <div class="modal-content">
        <p><strong>AI Access Readiness</strong><br>How easily AI models can discover and access your content.</p>
        <p><strong>Trust & Verification Signals</strong><br>Authority signals that AI models use to assess credibility.</p>
        <p><strong>LLM Interpretability & Clarity</strong><br>How well AI models can understand and parse your content.</p>
        <p><strong>Prompt-Pattern Alignment</strong><br>Technical factors affecting AI model interaction.</p>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const targetUrl = urlParams.get("url");

    const RENDER_FULL_ENDPOINT = "https://sniperank-v2-dev.onrender.com/api/full";

    // Modal handlers
    document.getElementById('breakdownBtn')?.addEventListener('click', () => {
      const bd = document.getElementById('breakdown-modal');
      bd.style.display = 'flex';
      bd.setAttribute('aria-hidden', 'false');
    });

    function closeModal(){
      const bd = document.getElementById('breakdown-modal');
      bd.style.display = 'none';
      bd.setAttribute('aria-hidden', 'true');
    }

    document.getElementById('modal-close')?.addEventListener('click', closeModal);
    document.getElementById('breakdown-modal')?.addEventListener('click', (e) => {
      if (e.target === document.getElementById('breakdown-modal')) closeModal();
    });

    // Email
    document.getElementById('emailBtn')?.addEventListener('click', () => {
      const subject = encodeURIComponent(`AiVi Report for ${targetUrl || ''}`);
      const body = encodeURIComponent(`View analysis: ${window.location.href}`);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    // Copy summary
    document.getElementById("copyBtn")?.addEventListener("click", async () => {
      const scoreText = document.getElementById("scoreNumber").textContent || "-/100";
      const txt = `Website: ${targetUrl}\nAiVi Score: ${scoreText}\n\nAnalysis: ${window.location.href}`;
      try {
        await navigator.clipboard.writeText(txt);
        const b = document.getElementById("copyBtn");
        const old = b.textContent;
        b.textContent = "âœ“ Copied!";
        setTimeout(() => b.textContent = old, 1500);
      } catch {
        window.prompt("Copy the summary:", txt);
      }
    });

    // Full report button
    document.getElementById("fullBtn")?.addEventListener("click", () => {
      if (!targetUrl) return;
      window.location.href = `/full-report.html?url=${encodeURIComponent(targetUrl)}`;
    });

    function safeArr(x){ return Array.isArray(x) ? x : []; }

    function toPillarPoints(val){
      const n = Number(val);
      if (!isFinite(n)) return 0;
      const normalized = n > 25 ? (n / 2) : n;
      return Math.max(0, Math.min(25, Math.round(normalized)));
    }

    function renderScoreCard(fullData){
      const raw = Number(fullData.rawScore ?? fullData.score?.rawScore ?? fullData.score ?? 0) || 0;
      const breakdown = fullData.breakdown || fullData.score?.breakdown || {};

      document.getElementById("scoreNumber").textContent = `${Math.round(raw)}/100`;
      document.getElementById("scoreBand").textContent =
        raw >= 80 ? "Rank: Excellent â˜…â˜…â˜…â˜…â˜…" :
        raw >= 60 ? "Rank: Strong â˜…â˜…â˜…â˜…â˜†" :
        raw >= 40 ? "Rank: Developing â˜…â˜…â˜…â˜†â˜†" :
        "Rank: At Risk â˜…â˜…â˜†â˜†â˜†";

      const grid = document.getElementById("pillarsGrid");
      grid.innerHTML = "";

      const pillars = [
        ["AI Access Readiness", toPillarPoints(breakdown.presence)],
        ["Trust & Verification Signals", toPillarPoints(breakdown.citations)],
        ["LLM Interpretability & Clarity", toPillarPoints(breakdown.answerability)],
        ["Prompt-Pattern Alignment", toPillarPoints(breakdown.technical)]
      ];

      pillars.forEach(([label, val]) => {
        const d = document.createElement("div");
        d.className = "pillar";
        d.innerHTML = `<span class="label">${label}</span><span class="badge">${val}/25</span>`;
        grid.appendChild(d);
      });
    }

    function buildKeyFindings(fullData){
      const tech = fullData.technical || {};
      const ans = fullData.answerability || {};

      const items = [];

      if (tech.indexable === true) items.push("Site appears indexable â€” supports discoverability.");
      if (tech.hasCanonical === true) items.push("Canonical tag detected â€” helps AI understand preferred URLs.");
      if (tech.hasTitleAndH1 === false) items.push("Missing or weak <title>/<h1> detected â€” major clarity signal for AI.");
      if (tech.performanceOk === false) items.push("Performance flags detected â€” can reduce crawl/parse success.");

      if (ans.hasFAQSchema === false) items.push("No FAQ schema detected â€” reduces Q&A answerability signals.");
      if (ans.entitiesInHeadings === true) items.push("Entities appear in headings â€” helps AI map topics.");
      if (ans.hasOtherSchema === true) items.push("Some structured data detected â€” helps AI interpret meaning.");

      return items;
    }

    function renderSections(fullData){
      const host = document.getElementById('summary-results');
      let html = '';

      const whatsWorking = safeArr(fullData.whatsWorking);
      const needsAttention = safeArr(fullData.needsAttention);
      const engineInsights = safeArr(fullData.engineInsights);
      const opportunities = safeArr(fullData.opportunities);

      if (whatsWorking.length) {
        html += '<h3 class="section-title">âœ… What\\'s Working</h3><ul>';
        whatsWorking.forEach(item => html += `<li>${item}</li>`);
        html += '</ul>';
      }

      if (needsAttention.length) {
        html += '<h3 class="section-title">ðŸš¨ Needs Attention</h3><ul>';
        needsAttention.forEach(item => html += `<li>${item}</li>`);
        html += '</ul>';
      }

      if (engineInsights.length) {
        html += '<h3 class="section-title">ðŸ“¡ AI Engine Insights</h3><ul>';
        engineInsights.forEach(item => html += `<li>${item}</li>`);
        html += '</ul>';
      }

      if (opportunities.length) {
        html += '<h3 class="section-title">ðŸŽ¯ Top Opportunities</h3><ul>';
        opportunities.slice(0, 10).forEach(opp => {
          const title = opp?.title ? `<strong>${opp.title}</strong>` : "<strong>Opportunity</strong>";
          const desc = opp?.description ? ` â€” ${opp.description}` : "";
          html += `<li>${title}${desc}</li>`;
        });
        html += '</ul>';
      }

      if (!html) {
        html = "<p style='text-align:center;color:#666'>No detailed sections were returned for this run.</p>";
      }

      host.innerHTML = html;
    }

    function showRetry(){
      const rb = document.getElementById("retryBtn");
      if (rb) rb.style.display = "inline-block";
    }

    async function fetchJsonOrThrow(url){
      const res = await fetch(url);
      let data = null;
      try { data = await res.json(); } catch {}
      if (!res.ok) {
        const msg = (data && data.error) ? String(data.error) : `Server returned ${res.status}`;
        const err = new Error(msg);
        err.status = res.status;
        throw err;
      }
      return data;
    }

    async function runAnalysis(){
      document.getElementById("retryBtn").style.display = "none";
      document.getElementById("scoreBand").textContent = "Loading AIV Score...";
      document.getElementById("scoreNumber").textContent = "â€”";
      document.getElementById('summary-results').innerHTML =
        "<p style='text-align:center;color:gray;'>Loading AI Visibility analysis...</p>";

      const primaryUrl = `/api/full?url=${encodeURIComponent(targetUrl)}`;
      const fallbackUrl = `${RENDER_FULL_ENDPOINT}?url=${encodeURIComponent(targetUrl)}`;

      try {
        // 1) Try Vercel same-origin endpoint
        const data = await fetchJsonOrThrow(primaryUrl);
        if (!data || data.success !== true) {
          const msg = data?.error ? String(data.error) : "Analysis unavailable.";
          throw new Error(msg);
        }

        renderScoreCard(data);

        const kf = buildKeyFindings(data);
        if (kf.length) {
          document.getElementById("keyFindingsCard").style.display = "block";
          const ul = document.getElementById("keyFindingsList");
          ul.innerHTML = "";
          kf.forEach(t => {
            const li = document.createElement("li");
            li.textContent = t;
            ul.appendChild(li);
          });
        }

        renderSections(data);
        return;

      } catch (e1) {
        // 2) Fallback to Render if Vercel fails
        try {
          const data2 = await fetchJsonOrThrow(fallbackUrl);
          if (!data2 || data2.success !== true) {
            const msg2 = data2?.error ? String(data2.error) : "Analysis unavailable.";
            throw new Error(msg2);
          }

          renderScoreCard(data2);

          const kf2 = buildKeyFindings(data2);
          if (kf2.length) {
            document.getElementById("keyFindingsCard").style.display = "block";
            const ul2 = document.getElementById("keyFindingsList");
            ul2.innerHTML = "";
            kf2.forEach(t => {
              const li = document.createElement("li");
              li.textContent = t;
              ul2.appendChild(li);
            });
          }

          renderSections(data2);
          return;

        } catch (e2) {
          console.error("Analyze error (primary):", e1);
          console.error("Analyze error (fallback):", e2);

          const msg =
            (e1 && e1.message ? e1.message : "Analysis failed.") +
            " â€” please retry.";

          document.getElementById('summary-results').innerHTML =
            `<p style="text-align:center;color:#666">${msg}</p>`;
          document.getElementById("scoreBand").textContent = "Score unavailable";
          document.getElementById("scoreNumber").textContent = "â€”";
          showRetry();
        }
      }
    }

    document.getElementById("retryBtn")?.addEventListener("click", () => {
      runAnalysis();
    });

    document.addEventListener("DOMContentLoaded", async () => {
      if (!targetUrl) {
        document.getElementById("current-url").textContent = "No URL provided";
        document.getElementById('summary-results').innerHTML =
          "<p style='text-align:center;color:red'>No URL provided. Please return to the <a href='/'>homepage</a> and enter a site to analyze.</p>";
        document.getElementById("scoreBand").textContent = "Score unavailable";
        document.getElementById("scoreNumber").textContent = "â€”";
        return;
      }

      document.getElementById("current-url").textContent = targetUrl;

      // Run analysis with fallback
      await runAnalysis();
    });
  </script>
</body>
</html>
