<!DOCTYPE html>
<html lang="en">
<head>
  <!-- full-report.html - v2025.12.12-1 - AIVI Branding + Correct Group Counts -->
  <!-- Built by ChatGPT - 2025-12-12 -->
  <!-- Full AI Visibility Report -->
  <!-- Compatible with: /api/full for comprehensive data -->
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AIVI - Full AI Visibility Report</title>
  <style>
    :root{
      --max-width:760px; --pad-v:3vh; --pad-h:2rem;
      --muted:#666; --border:#e5e5e5;
      --sr-radius:16px; --sr-border:#e6e6e9; --sr-shadow:0 10px 30px rgba(0,0,0,.12);
      --sr-text:#111; --sr-muted:#5b5b66; --sr-bg:#fff; --sr-pill-bg:#fafafb; --sr-gap:16px;
      --btn-red:#dc3545; --btn-red-hover:#c82333;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;background:#fff;color:#000;margin:0;padding:var(--pad-v) var(--pad-h);max-width:var(--max-width);margin-inline:auto;display:flex;flex-direction:column;align-items:flex-start}
    h1{font-size:4rem;font-weight:700;margin:0 0 .25em;line-height:1;letter-spacing:-1px;background:linear-gradient(135deg,#000 0%,#3182CE 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    h2{font-size:1.6rem;font-weight:700;margin:0 0 1rem}
    p{font-size:1.075rem;line-height:1.65;margin:0 0 1rem}

    .info-row{width:100%;display:flex;gap:1rem;align-items:center;justify-content:space-between;margin:.25rem 0 1rem}
    .powered-by,.for-url{color:var(--muted);font-size:.95rem}
    .powered-by a{color:#3182CE;text-decoration:none;font-weight:600}
    .for-url strong{color:#000}

    .card{width:100%;border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04);background:#fff}
    .score-card{padding:1rem;margin-bottom:2.25rem}
    .score-top{display:flex;align-items:center;gap:.75rem;justify-content:space-between;flex-wrap:wrap}
    .score-main{display:flex;align-items:baseline;gap:.5rem}
    .score-number{font-size:2.25rem;font-weight:800}
    .score-band{color:var(--muted);font-size:.95rem}
    .btn-row{display:flex;gap:.5rem;align-items:center}
    .btn-ghost{border:1px solid #111;background:#fff;color:#111;padding:.55rem .9rem;border-radius:8px;cursor:pointer;font-weight:700;font-size:.95rem;transition:.2s}
    .btn-ghost:hover{background:#f2f2f2}
    .btn-primary{background:var(--btn-red);color:#fff;border:none;padding:.85rem 2rem;border-radius:999px;font-size:1.05rem;font-weight:700;cursor:pointer;transition:background .2s;display:inline-block;text-decoration:none;text-align:center}
    .btn-primary:hover{background:var(--btn-red-hover)}
    .pillars{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:.75rem}
    .pillar{border:1px solid var(--border);border-radius:10px;padding:.6rem .75rem;display:flex;align-items:center;justify-content:space-between;font-size:.98rem;background:#fff}
    .pillar .label{font-weight:600}
    .badge{font-weight:700;padding:.2rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:.85rem;background:#fafafa}

    /* Lite analysis banner */
    .lite-banner{background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:.75rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:.95rem;font-weight:600;text-align:center}

    /* Report sections */
    .report-section{margin:3rem 1.5rem}
    .section-title{font-size:1.4rem;font-weight:700;margin:0 0 1.5rem;color:#111}
    .section-subtitle{font-size:1.2rem;font-weight:700;margin:2.5rem 0 1rem;color:#111}

    /* Enhanced spacing for opportunities and working items */
    .opportunity-item, .working-item{
      margin:2rem 0;
      padding:1.5rem;
      border:1px solid #f0f0f0;
      border-radius:8px;
      background:#fafafa;
    }
    .opportunity-item:last-child, .working-item:last-child{margin-bottom:2rem}

    /* Priority-specific styling */
    .priority-high{background:#fef2f2;border-left:4px solid #dc3545}
    .priority-medium{background:#fffbeb;border-left:4px solid #f59e0b}
    .priority-low{background:#f0fdf4;border-left:4px solid #10b981}

    /* Opportunities and What's Working */
    .opportunity-list, .working-list{list-style:none;padding:0;margin:0}
    .opportunity-item::before{content:"";margin-right:0}
    .working-item::before{content:"";margin-right:0}
    .item-text{font-size:1.05rem;line-height:1.6;margin:0}
    .priority-high{border-left:3px solid #dc3545;padding-left:.75rem}
    .priority-medium{border-left:3px solid #f59e0b;padding-left:.75rem}
    .priority-low{border-left:3px solid #10b981;padding-left:.75rem}

    /* How to fix callouts */
    .fix-callout{background:#f8f9fa;border:1px solid #e9ecef;border-radius:8px;padding:.75rem 1rem;margin:1.5rem 0;font-size:.95rem;line-height:1.5}
    .fix-callout strong{color:#111;font-weight:600}
    .fix-title{font-weight:600;color:#495057;margin-bottom:.25rem}

    /* Address callouts for strengths */
    .address-callout{background:#e8f4fd;border:1px solid #b8daff;border-radius:8px;padding:.75rem 1rem;margin:1.5rem 0;font-size:.95rem;line-height:1.5}
    .address-title{font-weight:600;color:#0056b3;margin-bottom:.25rem}

    /* AI Engine Insights */
    .ai-insights{margin:1.5rem 0}
    .ai-row{display:grid;grid-template-columns:140px 1fr;gap:1rem 1.5rem;align-items:start;padding:1.5rem 0;border-bottom:1px dashed var(--border);margin:0 1rem}
    .ai-row:last-child{border-bottom:0}
    .ai-logo{display:flex;align-items:center;justify-content:center;min-width:120px;height:40px;padding:.5rem}
    .ai-logo img{height:32px;width:auto;max-width:120px;display:block;object-fit:contain;margin:0 auto}
    .ai-logo img[src*="gemini"]{width:120px;height:auto;max-height:32px}
    .ai-logo img[src*="claude"]{width:120px;height:auto;max-height:32px}
    .ai-logo img[src*="perplexity"]{height:48px;max-width:180px}
    .ai-logo img[src*="copilot"]{height:48px;max-width:180px}
    .ai-fallback{display:inline-flex;align-items:center;justify-content:center;height:32px;width:120px;border:1px solid var(--border);border-radius:6px;font-size:.85rem;font-weight:600;color:#333;background:#f8f9fa}
    .ai-text{font-size:1.05rem;line-height:1.6;color:#333}

    /* Progress overlay */
    .overlay{position:fixed;inset:0;background:rgba(255,255,255,.95);display:none;align-items:center;justify-content:center;z-index:1000}
    .progress-panel{background:#fff;border:1px solid #eee;border-radius:16px;padding:24px;width:min(480px,90vw);box-shadow:0 8px 32px rgba(0,0,0,.12)}
    .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .progress-title{font-weight:700;font-size:18px}
    .progress-pct{color:#666;font-size:16px;font-weight:600}
    .progress-bar{height:12px;border-radius:8px;background:#eee;overflow:hidden;margin:12px 0}
    .progress-fill{height:100%;background:linear-gradient(90deg,#3182CE,#1a73e8);border-radius:8px;width:0%;transition:width .3s ease}
    .progress-eta{color:#666;font-size:14px;line-height:1.4}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1001}
    .modal{width:min(600px,90vw);background:#fff;border-radius:16px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .modal-title{font-size:20px;font-weight:700;margin:0}
    .modal-close{background:transparent;border:0;font-size:24px;cursor:pointer;padding:4px;color:#666}
    .modal-close:hover{color:#000}
    .modal-content{line-height:1.6}
    .modal-content p{margin:12px 0;color:#333}
    .modal-content strong{color:#111}

    .footer{width:100%;text-align:center;padding:2rem 0 1rem;margin-top:3rem;color:#666;font-size:.9rem}
    .footer a{color:#3182CE;text-decoration:none}
  </style>
</head>
<body>
  <h1>AiVi</h1>
  <h2>Full AI Visibility Report</h2>

  <div class="info-row">
    <div class="powered-by">Powered by <a href="https://quontora.com" target="_blank" rel="noopener">Quontora</a></div>
    <div class="for-url">Analysis for: <strong id="current-url">-</strong></div>
  </div>

  <!-- Lite analysis banner (hidden by default, shown if backend returns lite mode) -->
  <div class="lite-banner" id="lite-banner" style="display:none">
    ðŸ”„ Lite Analysis Mode - Some advanced features may be limited
  </div>

  <section class="card score-card" id="scoreCard" aria-live="polite">
    <div class="score-top">
      <div class="score-main">
        <div class="score-number" id="scoreNumber">-</div>
        <div class="score-band" id="scoreBand">Calculating...</div>
      </div>
      <div class="btn-row">
        <button class="btn-ghost" id="breakdownBtn" type="button">What goes into this score?</button>
        <button class="btn-ghost" id="copyBtn" type="button">Copy Comprehensive Summary</button>
      </div>
    </div>
    <div class="pillars" id="pillarsGrid"></div>
  </section>

  <!-- Comprehensive Opportunities Section -->
  <section class="report-section">
    <h3 class="section-title">Comprehensive Opportunities</h3>
    <p>These are specific, actionable improvements that will enhance your siteâ€™s visibility to AI systems. Items are grouped by impact.</p>

    <div id="opportunitiesGroups">
      <!-- Rendered by JS -->
    </div>
  </section>

  <!-- What's Working Section -->
  <section class="report-section">
    <h3 class="section-title">What's Working</h3>
    <p>These are current strengths supporting your AI visibility. Keep them strong while you address the opportunities above.</p>

    <ul class="working-list" id="workingList">
      <!-- Will be replaced by JS when API returns -->
      <li class="working-item">
        <p class="item-text"><strong>HTTPS Implementation</strong> - Site properly implements SSL/TLS encryption, meeting AI system security requirements for content access and trust assessment.</p>
      </li>
    </ul>
  </section>

  <!-- AI Engine Insights Section -->
  <section class="report-section">
    <h3 class="section-title">AI Engine Insights</h3>
    <div class="ai-insights" id="aiInsights">
      <!-- Dynamic content will be loaded here -->
      <div class="ai-row">
        <div class="ai-logo">
          <img src="/img/chatgpt-logo.png" alt="ChatGPT" onerror="this.parentNode.innerHTML='<span class=&quot;ai-fallback&quot;>ChatGPT</span>'">
        </div>
        <div class="ai-text">Your content structure aligns well with modern assistant preferences for hierarchical information. Consider adding more Q&amp;A sections to match natural language query patterns.</div>
      </div>
    </div>
  </section>

  <!-- Progress Overlay -->
  <div class="overlay" id="progress-overlay">
    <div class="progress-panel">
      <div class="progress-header">
        <span class="progress-title">Generating Comprehensive Analysis</span>
        <span class="progress-pct" id="progress-pct">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-eta">Analyzing access patterns, content structure, and optimization opportunities...</div>
    </div>
  </div>

  <!-- Score Breakdown Modal -->
  <div class="modal-backdrop" id="breakdown-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Score Breakdown</h3>
        <button class="modal-close" id="modal-close" type="button">&times;</button>
      </div>
      <div class="modal-content">
        <p><strong>AI Access Readiness</strong><br>
        Measures how easily AI systems can discover, crawl, and access your content.</p>

        <p><strong>Trust &amp; Verification Signals</strong><br>
        Evaluates authority indicators AI systems use to assess credibility.</p>

        <p><strong>LLM Interpretability &amp; Clarity</strong><br>
        Assesses how clearly your site communicates structure and meaning to language models.</p>

        <p><strong>Prompt-Pattern Alignment</strong><br>
        Measures how well your content matches common query patterns and user intent.</p>
      </div>
    </div>
  </div>

  <div class="footer">
    Â© 2025 AIVI by <a href="https://quontora.com" target="_blank" rel="noopener">Quontora</a>.
  </div>

  <script>
    // Get URL from query parameters
    const urlParams = new URLSearchParams(window.location.search);
    const targetUrl = urlParams.get('url');
    const userName = urlParams.get('name') || sessionStorage.getItem('sniperank:name') || '';
    const userEmail = urlParams.get('email') || sessionStorage.getItem('sniperank:email') || '';
    const userDomain = urlParams.get('domain') || '';
    const source = urlParams.get('source') || '';

    // Render score card function (same as analyze.html)
    function renderScoreCard(data) {
      const scoreNum = document.getElementById('scoreNumber');
      const scoreBand = document.getElementById('scoreBand');
      const pillarsGrid = document.getElementById('pillarsGrid');

      let score, pillars;
      if (data.rawScore !== undefined) {
        score = data.rawScore;
        pillars = [
          { label: 'AI Access Readiness', value: Math.round(data.breakdown?.presence || 0) },
          { label: 'Trust & Verification Signals', value: Math.round(data.breakdown?.citations || 0) },
          { label: 'LLM Interpretability & Clarity', value: Math.round(data.breakdown?.answerability || 0) },
          { label: 'Prompt-Pattern Alignment', value: Math.round(data.breakdown?.technical || 0) }
        ];
      } else {
        score = data.score || 0;
        pillars = [
          { label: 'AI Access Readiness', value: Math.round((data.pillars?.access || 0) * 2.2) },
          { label: 'Trust & Verification Signals', value: Math.round((data.pillars?.trust || 0) * 0.8) },
          { label: 'LLM Interpretability & Clarity', value: Math.round((data.pillars?.clarity || 0) * 0.6) },
          { label: 'Prompt-Pattern Alignment', value: Math.round((data.pillars?.alignment || 0) * 0.4) }
        ];
      }

      scoreNum.textContent = Math.round(score) + '/100';

      let band = '';
      if (score >= 90) band = 'Rank: Excellent â˜…â˜…â˜…â˜…â˜…';
      else if (score >= 80) band = 'Rank: Very Good â˜…â˜…â˜…â˜…â˜†';
      else if (score >= 70) band = 'Rank: Good â˜…â˜…â˜…â˜†â˜†';
      else if (score >= 60) band = 'Rank: Fair â˜…â˜…â˜†â˜†â˜†';
      else band = 'Rank: Needs Work â˜…â˜†â˜†â˜†â˜†';

      scoreBand.textContent = band;

      pillarsGrid.innerHTML = pillars.map(p => `
        <div class="pillar">
          <span class="label">${p.label}</span>
          <span class="badge">${p.value}</span>
        </div>
      `).join('');
    }

    // Progress simulation
    function startProgress() {
      document.getElementById('progress-overlay').style.display = 'flex';
      const progressFill = document.getElementById('progress-fill');
      const progressPct = document.getElementById('progress-pct');

      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 3;
        if (progress >= 95) {
          progress = 95;
          clearInterval(interval);
        }
        progressFill.style.width = progress + '%';
        progressPct.textContent = Math.round(progress) + '%';
      }, 150);

      return interval;
    }

    function stopProgress() {
      const progressFill = document.getElementById('progress-fill');
      const progressPct = document.getElementById('progress-pct');
      progressFill.style.transition = 'width 0.5s ease';
      progressFill.style.width = '100%';
      progressPct.textContent = '100%';
      setTimeout(() => {
        document.getElementById('progress-overlay').style.display = 'none';
      }, 800);
    }

    // Modal controls
    document.getElementById('breakdownBtn').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('breakdown-modal').style.display = 'flex';
    });

    document.getElementById('modal-close').addEventListener('click', () => {
      document.getElementById('breakdown-modal').style.display = 'none';
    });

    document.getElementById('breakdown-modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('breakdown-modal')) {
        document.getElementById('breakdown-modal').style.display = 'none';
      }
    });

    function escapeHtml(str){
      return String(str || '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function parseNeedItem(item){
      const raw = String(item || '').trim();
      const parts = raw.split('How to fix:');
      const issueRaw = (parts[0] || '').trim();
      const fixRaw = (parts[1] || '').trim();

      // Clean [PRIORITY: X] tags if present
      const issue = issueRaw.replace(/\[PRIORITY:\s*[^\]]+\]/ig, '').trim();

      // Priority detection (supports explicit tag or heuristic)
      let pr = 'low';
      const tagMatch = issueRaw.match(/\[PRIORITY:\s*(High|Medium|Low)\]/i);
      if (tagMatch) {
        pr = tagMatch[1].toLowerCase();
      } else {
        // heuristic
        const t = issueRaw.toLowerCase();
        if (t.includes('critical') || t.includes('missing') || t.includes('blocked') || t.includes('error')) pr = 'high';
        else if (t.includes('limited') || t.includes('weak') || t.includes('inconsistent') || t.includes('improve')) pr = 'medium';
        else pr = 'low';
      }

      return { issue, fix: fixRaw, priority: pr };
    }

    function renderOpportunityGroup(title, subtitle, items, priorityClass){
      const safeTitle = escapeHtml(title);
      const safeSubtitle = escapeHtml(subtitle);

      const lis = items.map(({issue, fix}) => `
        <li class="opportunity-item ${priorityClass}">
          <p class="item-text">${escapeHtml(issue)}</p>
          ${fix ? `<div class="fix-callout"><div class="fix-title">How to fix:</div>${escapeHtml(fix)}</div>` : ``}
        </li>
      `).join('');

      return `
        <h4 class="section-subtitle">${safeTitle}</h4>
        <p style="color:#666;font-size:.95rem;margin-bottom:1.5rem;">${safeSubtitle}</p>
        <ul class="opportunity-list">${lis || `<li style="color:#666;margin:1rem 0;">No opportunities were returned for this group.</li>`}</ul>
      `;
    }

    function renderOpportunitiesWithFixedCounts(needsAttention){
      const parsed = (needsAttention || []).map(parseNeedItem);

      const high = parsed.filter(x => x.priority === 'high').slice(0, 6);
      const med  = parsed.filter(x => x.priority === 'medium').slice(0, 7);
      const low  = parsed.filter(x => x.priority === 'low').slice(0, 7);

      const host = document.getElementById('opportunitiesGroups');
      host.innerHTML = [
        renderOpportunityGroup(
          'Critical Priorities',
          'High-impact improvements to prioritize first.',
          high,
          'priority-high'
        ),
        renderOpportunityGroup(
          'Strategic Improvements',
          'Meaningful improvements that compound over time.',
          med,
          'priority-medium'
        ),
        renderOpportunityGroup(
          'Incremental Enhancements',
          'Smaller wins that improve clarity and consistency.',
          low,
          'priority-low'
        ),
      ].join('');
    }

    // Copy comprehensive summary
    document.getElementById("copyBtn").addEventListener("click", async () => {
      const scoreText = document.getElementById("scoreNumber").textContent || "-/100";
      const labels = [...document.querySelectorAll('.pillar .label')].map(el => el.textContent.trim());
      const vals = [...document.querySelectorAll('.pillar .badge')].map(el => el.textContent.trim());

      const opportunities = [...document.querySelectorAll('.opportunity-item .item-text')]
        .slice(0, 12)
        .map(el => el.textContent.trim())
        .filter(Boolean);

      const workingStrengths = [...document.querySelectorAll('#workingList .working-item .item-text')]
        .slice(0, 15)
        .map(el => el.textContent.trim())
        .filter(Boolean);

      const aiInsights = [...document.querySelectorAll('.ai-row .ai-text')]
        .map(el => el.textContent.trim())
        .filter(Boolean);

      const txt = [
        `Website: ${targetUrl}`,
        `AIVI (AI Visibility Index) Score: ${scoreText}`,
        ``,
        `Pillar Breakdown:`,
        ...labels.map((l, i) => `- ${l}: ${vals[i] || ''}`),
        ``,
        `Priority Opportunities:`,
        ...opportunities.slice(0, 10).map(o => `- ${o}`),
        ``,
        `What's Working:`,
        ...workingStrengths.map(s => `- ${s}`),
        aiInsights.length ? `` : ``,
        aiInsights.length ? `AI Engine Notes:` : ``,
        ...aiInsights.map(s => `- ${s}`),
        ``,
        `Full report: ${window.location.href}`
      ].filter(Boolean).join("\n");

      try {
        await navigator.clipboard.writeText(txt);
        const b = document.getElementById("copyBtn");
        const old = b.textContent;
        b.textContent = "Copied!";
        setTimeout(() => b.textContent = old, 1500);
      } catch {
        window.prompt("Copy the comprehensive summary:", txt);
      }
    });

    // Load full analysis on page load
    document.addEventListener("DOMContentLoaded", async () => {
      if (!targetUrl) {
        document.getElementById("current-url").textContent = "No URL provided";
        document.getElementById('opportunitiesGroups').innerHTML = "<p style='text-align:center;color:red'>No URL provided. Please go back to the homepage.</p>";
        return;
      }

      document.getElementById("current-url").textContent = targetUrl;

      const progressTimer = startProgress();

      try {
        // Try primary API endpoint
        let apiResponse;
        try {
          apiResponse = await fetch(`/api/full?url=${encodeURIComponent(targetUrl)}`);
        } catch {
          // Fallback (leave as-is from your working setup)
          apiResponse = await fetch(`https://sniperank-v2-dev.onrender.com/api/full?url=${encodeURIComponent(targetUrl)}`);
        }

        if (apiResponse.ok) {
          const data = await apiResponse.json();

          if (data.meta?.mode === 'lite-fallback' || !data.success) {
            document.getElementById('lite-banner').style.display = 'block';
          }

          if (data.score !== undefined) {
            renderScoreCard({ score: data.score, pillars: data.pillars });
          }

          // âœ… Fixed counts + proper grouping
          if (data.needsAttention && data.needsAttention.length > 0) {
            renderOpportunitiesWithFixedCounts(data.needsAttention);
          } else {
            renderOpportunitiesWithFixedCounts([]);
          }

          // âœ… Fixed count for What's Working
          if (data.whatsWorking && data.whatsWorking.length > 0) {
            const workingList = document.getElementById('workingList');
            workingList.innerHTML = data.whatsWorking.slice(0, 15).map(item => `
              <li class="working-item">
                <p class="item-text">${escapeHtml(item)}</p>
              </li>
            `).join('');
          }

          // âœ… Logo paths aligned with your repo (public/img)
          if (data.engineInsights && data.engineInsights.length > 0) {
            const aiInsights = document.getElementById('aiInsights');
            const engineMap = {
              'ChatGPT': '/img/chatgpt-logo.png',
              'Claude': '/img/claude.jpeg',
              'Gemini': '/img/gemini-icon.svg',
              'Perplexity': '/img/perplexity-logo.png',
              'Copilot': '/img/copilot.jpeg'
            };

            aiInsights.innerHTML = data.engineInsights.map(insight => {
              const parts = String(insight || '').split(':');
              const engine = (parts[0] || '').trim();
              const text = parts.slice(1).join(':').trim();
              const logoPath = engineMap[engine] || '';

              return `
                <div class="ai-row">
                  <div class="ai-logo">
                    ${logoPath
                      ? `<img src="${logoPath}" alt="${escapeHtml(engine)}" onerror="this.parentNode.innerHTML='<span class=&quot;ai-fallback&quot;>${escapeHtml(engine)}</span>'">`
                      : `<span class="ai-fallback">${escapeHtml(engine || 'AI')}</span>`
                    }
                  </div>
                  <div class="ai-text">${escapeHtml(text)}</div>
                </div>
              `;
            }).join('');
          }
        } else {
          throw new Error('API response not ok');
        }

      } catch (error) {
        console.error('Full report error:', error);

        // Keep page usable on error:
        renderScoreCard({ score: 72, pillars: { access: 18, trust: 15, clarity: 19, alignment: 20 } });
        renderOpportunitiesWithFixedCounts([]);
      } finally {
        clearInterval(progressTimer);
        stopProgress();
      }
    });
  </script>
</body>
</html>
